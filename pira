local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local backpack = player:WaitForChild("Backpack")
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")
local mouse = player:GetMouse()

local barrelsFolder = workspace:WaitForChild("Barrels"):WaitForChild("Barrels")
local cratesFolder = workspace:WaitForChild("Barrels"):WaitForChild("Crates")
local kitchenFolder = workspace:WaitForChild("Island8"):WaitForChild("Kitchen")

local random = Random.new()

-- Respawn if dead
local function ensureAlive()
    if not humanoid or humanoid.Health <= 0 then
        local success, err = pcall(function()
            ReplicatedStorage:WaitForChild("Connections"):WaitForChild("Spawn"):FireServer(1)
        end)
        if not success then warn("Respawn failed: " .. err) end
        character = player.Character or player.CharacterAdded:Wait()
        humanoid = character:WaitForChild("Humanoid")
        rootPart = character:WaitForChild("HumanoidRootPart")
    end
end

-- Fly to target with tween (nhảy trước khi bay + bay nhanh hơn)
local function flyToTarget(pos)
    humanoid.Jump = true
    task.wait(0.5)
    humanoid.Jump = false

    local originalSpeed = humanoid.WalkSpeed
    local originalJump = humanoid.JumpPower

    humanoid.WalkSpeed = 115
    humanoid.JumpPower = 0

    local distance = (pos - rootPart.Position).Magnitude
    local duration = distance / 300 -- bay nhanh hơn

    local tween = TweenService:Create(rootPart, TweenInfo.new(duration, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {CFrame = CFrame.new(pos)})
    tween:Play()
    tween.Completed:Wait()

    humanoid.WalkSpeed = originalSpeed
    humanoid.JumpPower = originalJump
end

-- Click with delay
local function simulateClick(obj)
    if obj and obj:FindFirstChild("ClickDetector") then
        task.wait(random:NextNumber(0.2, 0.5))
        fireclickdetector(obj.ClickDetector)
    end
end

-- Anti-AFK movement
local function antiAfk()
    humanoid.Jump = true
    task.wait(0.5)
    humanoid.Jump = false
    humanoid:Move(Vector3.new(random:NextNumber(-5, 5), 0, random:NextNumber(-5, 5)), true)
    task.wait(0.5)
end

-- Find nearest object
local function findNearest(list)
    local closest, minDist = nil, math.huge
    for _, obj in pairs(list) do
        local dist = (obj.Position - rootPart.Position).Magnitude
        if dist < minDist then
            minDist = dist
            closest = obj
        end
    end
    return closest
end

-- Handle tools when mouse is clicked
local function handleToolsWithMouse()
    mouse.Button1Down:Connect(function()
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") and (tool.Name:lower():find("juice") or tool.Name:lower():find("milk")) then
                humanoid:EquipTool(tool)
                task.wait(0.2)
                if tool:FindFirstChild("ClickDetector") then
                    fireclickdetector(tool.ClickDetector)
                    task.wait(0.1)
                end
            end
        end
    end)
end

-- Khởi động xử lý chuột ngay từ đầu
handleToolsWithMouse()

-- Main loop
while true do
    ensureAlive()

    -- Nếu backpack đầy thì xử lý Mixer2
    if #backpack:GetChildren() > 75 then
        for _, folder in pairs(kitchenFolder:GetChildren()) do
            local bowl = folder:FindFirstChild("JuicingBowl")
            if bowl then
                local mixer = bowl:FindFirstChild("Mixer2")
                if mixer and mixer:FindFirstChild("ClickDetector") then
                    local offset = Vector3.new(random:NextNumber(-2, 2), 5, random:NextNumber(-2, 2))
                    flyToTarget(mixer.Position + offset)
                    task.wait(random:NextNumber(0.5, 1.5))
                    simulateClick(mixer)
                    antiAfk()
                end
            end
        end
    else
        -- Nếu chưa đầy thì xử lý barrel/crate
        local targets = {}
        for _, obj in pairs(barrelsFolder:GetChildren()) do
            if obj:FindFirstChild("ClickDetector") then table.insert(targets, obj) end
        end
        for _, obj in pairs(cratesFolder:GetChildren()) do
            if obj:FindFirstChild("ClickDetector") then table.insert(targets, obj) end
        end

        while #targets > 0 do
            ensureAlive()
            if #backpack:GetChildren() > 75 then
                break -- ngừng xử lý nếu backpack đã đầy
            end

            local target = findNearest(targets)
            if target then
                local offset = Vector3.new(random:NextNumber(-2, 2), 5, random:NextNumber(-2, 2))
                flyToTarget(target.Position + offset)
                task.wait(random:NextNumber(0.1, 0.5))
                simulateClick(target)
                antiAfk()
                for i, obj in pairs(targets) do
                    if obj == target then table.remove(targets, i) break end
                end
            end
        end
    end

    task.wait(10)
end
