getgenv().Target = "matrix4QFeycYL0pz"
getgenv().Select_Pet = {
    "Corrupted Kitsune",
    "Kitsune"
}
getgenv().Kick_After_Trade = false
repeat task.wait() until game:IsLoaded()
repeat task.wait() until game.Players.LocalPlayer.Character

local plr = game:GetService("Players").LocalPlayer
local VirtualUser = game:service "VirtualUser"

while not (plr:GetAttribute("DataFullyLoaded") and plr:GetAttribute("Finished_Loading")) do
    task.wait()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end

plr.Idled:connect(
    function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end
)

local function check_pet(name)
    local petname = string.match(name, "^(.-)%s%[")
    if petname then
        for i, v in pairs(getgenv().Select_Pet) do
            if v:lower() == petname:lower() then
                return true
            end
        end
    end
    return false
end

-- Hàm thay thế table.find cho Lua cũ
local function table_find(tbl, val)
    for _, v in pairs(tbl) do
        if v == val then return true end
    end
    return false
end

local save = {}

if getgenv().Target == plr.Name then
    game:GetService("ReplicatedStorage"):FindFirstChild("GameEvents"):FindFirstChild("GiftPet").OnClientEvent:Connect(function(id, name, sender)
        pcall(function()
            game:GetService("ReplicatedStorage"):FindFirstChild("GameEvents"):FindFirstChild("AcceptPetGift"):FireServer(true, id)
            task.wait(5)
        end)
    end)
else
    for i, v in pairs(plr:FindFirstChild("Backpack"):GetChildren()) do
        if v:IsA("Tool") and v:GetAttribute("ItemType") == "Pet" and check_pet(v.Name) then
            if not table_find(save, v) then
                table.insert(save, v)
            end
        end
    end
    while task.wait() do
        for i, v in pairs(save) do
            local petTool = plr:FindFirstChild("Backpack"):FindFirstChild(v.Name)
            if petTool then
                -- Ưu tiên kiểm tra và bỏ favorite nếu cần
                unlock_favorite_pet(petTool)
                local huy = game:GetService("Players"):FindFirstChild(getgenv().Target)
                if huy then
                    plr.Character.Humanoid:EquipTool(petTool)
                    game:GetService("ReplicatedStorage"):WaitForChild("GameEvents"):WaitForChild("PetGiftingService"):FireServer("GivePet", huy)
                    task.wait(5)
                end
            else
                save[i] = nil
            end
        end
        if #save == 0 then
            break
        end
    end
    writefile(plr.Name .. ".txt", "Completed-gom pet")
    if getgenv().Kick_After_Trade then
        plr:Kick("Done")
    end
end

local function unlock_favorite_pet(tool)
    local plr = game:GetService("Players").LocalPlayer
    local gui = plr.PlayerGui:FindFirstChild("BackpackGui")
    if not gui then return false end

    -- Equip tool lên tay
    plr.Character.Humanoid:EquipTool(tool)
    task.wait(0.2)

    -- Kiểm tra slot đang được chọn trên Hotbar (Background.Visible = true)
    local hotbar = gui.Backpack.Hotbar
    local selectedSlot
    for _, slot in ipairs(hotbar:GetChildren()) do
        if slot:IsA("Frame") and slot:FindFirstChild("Background") and slot.Background.Visible then
            selectedSlot = slot
            break
        end
    end

    if selectedSlot and selectedSlot:FindFirstChild("FavIcon") then
        local fav = selectedSlot.FavIcon
        if fav.Visible then
            task.wait(2)
            game:GetService("ReplicatedStorage"):WaitForChild("GameEvents"):WaitForChild("Favorite_Item"):FireServer(tool)
            print("Đã gửi remote bỏ favorite cho:", tool.Name)
            return true
        else
            print("Tool không favorite, có thể gift luôn.")
            return false
        end
    else
        print("Không xác định được slot đang cầm tool.")
        return false
    end
end
