-- Auto collect + drop (real drop) to stopped players or manual target
-- Supports manual target name via getgenv().UseManualTarget / getgenv().TargetName

getgenv().Config = {
    ["MaxTools"] = 20,
    ["FlySpeed"] = 300,
    ["ClickDelayMin"] = 0.2,
    ["ClickDelayMax"] = 0.5,
    ["AntiAfkInterval"] = 0.5,
    ["LoopDelay"] = 2,
    ["StoppedVelocityThreshold"] = 1
}

-- === MANUAL TARGET SETTINGS ===
getgenv().UseManualTarget = true
getgenv().TargetName = "YoutubeHuyGamer"

repeat task.wait() until game:IsLoaded()
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
repeat task.wait() until LocalPlayer and LocalPlayer:FindFirstChild("Backpack") and LocalPlayer:FindFirstChild("PlayerGui")

-- Anti-AFK
LocalPlayer.Idled:Connect(function()
    local vu = game:GetService("VirtualUser")
    pcall(function()
        vu:CaptureController()
        vu:ClickButton2(Vector2.new())
    end)
end)

-- Create DropLog
if not workspace:FindFirstChild("DropLog") then
    Instance.new("Folder", workspace).Name = "DropLog"
end

-- UI Tool Counter
if not LocalPlayer.PlayerGui:FindFirstChild("ToolCounterGui") then
    local gui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
    gui.Name = "ToolCounterGui"
    gui.ResetOnSpawn = false

    local label = Instance.new("TextLabel", gui)
    label.Name = "CountLabel"
    label.Size = UDim2.new(0, 220, 0, 50)
    label.Position = UDim2.new(0.5, -110, 0.05, 0)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextStrokeTransparency = 0.5
    label.Text = "Tools: 0"
end

-- Update Tool Count
task.spawn(function()
    while task.wait(0.5) do
        if LocalPlayer:FindFirstChild("Backpack") then
            local count = 0
            for _, t in ipairs(LocalPlayer.Backpack:GetChildren()) do
                if t:IsA("Tool") then count += 1 end
            end
            local gui = LocalPlayer.PlayerGui:FindFirstChild("ToolCounterGui")
            if gui and gui:FindFirstChild("CountLabel") then
                gui.CountLabel.Text = "Tools: " .. count
                gui.CountLabel.TextColor3 = (count >= getgenv().Config["MaxTools"])
                    and Color3.fromRGB(255,100,100) or Color3.new(1,1,1)
            end
        end
    end
end)

-- Utils
local function isAlive()
    local char = LocalPlayer.Character
    return char and char:FindFirstChild("Humanoid") and char.Humanoid.Health > 0
end

local function ensureAlive()
    if not isAlive() then
        LocalPlayer.CharacterAdded:Wait()
        task.wait(1)
    end
end

local TweenService = game:GetService("TweenService")
local function flyToTarget(pos)
    local char = LocalPlayer.Character
    if not (char and char:FindFirstChild("HumanoidRootPart")) then return end
    local root, humanoid = char.HumanoidRootPart, char:FindFirstChild("Humanoid")
    local dist = (pos - root.Position).Magnitude
    local duration = math.max(0.2, dist / getgenv().Config["FlySpeed"])
    local tween = TweenService:Create(root, TweenInfo.new(duration, Enum.EasingStyle.Quad), {CFrame = CFrame.new(pos)})
    tween:Play()
    tween.Completed:Wait()
end

local function antiAfk()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") then
        char.Humanoid.Jump = true
        task.wait(getgenv().Config["AntiAfkInterval"])
        char.Humanoid.Jump = false
    end
end

local function findNearestStoppedPlayer(range)
    range = range or 200
    local myChar = LocalPlayer.Character
    if not (myChar and myChar:FindFirstChild("HumanoidRootPart")) then return end
    local myPos = myChar.HumanoidRootPart.Position
    local best, bestDist
    for _, pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
            local root, hum = pl.Character.HumanoidRootPart, pl.Character.Humanoid
            if hum.Health > 0 and root.Velocity.Magnitude <= getgenv().Config["StoppedVelocityThreshold"] then
                local dist = (root.Position - myPos).Magnitude
                if dist <= range and (not bestDist or dist < bestDist) then
                    best, bestDist = pl, dist
                end
            end
        end
    end
    return best
end

local function findPlayerByName(name)
    for _, pl in ipairs(Players:GetPlayers()) do
        if pl.Name == name then return pl end
    end
end

-- === DROP THẬT ===
local function dropAllTools()
    local backpack = LocalPlayer.Backpack
    local char = LocalPlayer.Character
    if not (backpack and char and char:FindFirstChild("Humanoid")) then return end
    local humanoid = char.Humanoid
    local vim = game:GetService("VirtualInputManager")

    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA("Tool") then
            humanoid:EquipTool(tool)
            task.wait(0.15)
            vim:SendKeyEvent(true, Enum.KeyCode.Backspace, false, game)
            task.wait(0.05)
            vim:SendKeyEvent(false, Enum.KeyCode.Backspace, false, game)
            task.wait(0.2)
        end
    end
end

-- Log Drop
local function logDropRecipient(player)
    local folder = workspace:FindFirstChild("DropLog")
    local sv = Instance.new("StringValue")
    sv.Name = os.time() .. "_" .. (player and player.Name or "Unknown")
    sv.Value = (player and player.Name or "Unknown") .. " | Pos: " ..
        tostring(player and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character.HumanoidRootPart.Position) ..
        " | Time: " .. os.date("%Y-%m-%d %H:%M:%S")
    sv.Parent = folder
end

-- Click simulation
local function simulateClick(obj)
    if not obj then return end
    local delay = math.random() * (getgenv().Config["ClickDelayMax"] - getgenv().Config["ClickDelayMin"]) + getgenv().Config["ClickDelayMin"]
    task.wait(delay)
    if obj:FindFirstChild("ClickDetector") then
        pcall(function() fireclickdetector(obj.ClickDetector) end)
    end
end

-- Main Loop
task.spawn(function()
    local RandomGen = Random.new()
    while task.wait(getgenv().Config["LoopDelay"]) do
        ensureAlive()
        local backpack = LocalPlayer.Backpack
        local count = 0
        for _, t in ipairs(backpack:GetChildren()) do if t:IsA("Tool") then count += 1 end end

        if count >= getgenv().Config["MaxTools"] then
            local recipient
            if getgenv().UseManualTarget then
                recipient = findPlayerByName(getgenv().TargetName)
            end
            if not recipient then
                recipient = findNearestStoppedPlayer(200)
            end

            if recipient and recipient.Character and recipient.Character:FindFirstChild("HumanoidRootPart") then
                logDropRecipient(recipient)
                flyToTarget(recipient.Character.HumanoidRootPart.Position + Vector3.new(0,0,2))
                task.wait(0.5)
                dropAllTools()
            else
                dropAllTools()
            end
        else
            -- Collect barrels/crates
            local barrels = workspace:FindFirstChild("Barrels")
            if barrels then
                local targets = {}
                if barrels:FindFirstChild("Barrels") then
                    for _, obj in pairs(barrels.Barrels:GetChildren()) do
                        if obj:IsA("BasePart") and obj:FindFirstChild("ClickDetector") then
                            table.insert(targets, obj)
                        end
                    end
                end
                if barrels:FindFirstChild("Crates") then
                    for _, obj in pairs(barrels.Crates:GetChildren()) do
                        if obj:IsA("BasePart") and obj:FindFirstChild("ClickDetector") then
                            table.insert(targets, obj)
                        end
                    end
                end

                while #targets > 0 and count < getgenv().Config["MaxTools"] do
                    ensureAlive()
                    local char = LocalPlayer.Character
                    if not char or not char:FindFirstChild("HumanoidRootPart") then break end

                    -- chọn gần nhất
                    local closest, minDist
                    for _, obj in pairs(targets) do
                        local dist = (obj.Position - char.HumanoidRootPart.Position).Magnitude
                        if not minDist or dist < minDist then
                            closest, minDist = obj, dist
                        end
                    end
                    if not closest then break end

                    flyToTarget(closest.Position + Vector3.new(RandomGen:NextNumber(-2,2), 5, RandomGen:NextNumber(-2,2)))
                    task.wait(RandomGen:NextNumber(0.1,0.5))
                    simulateClick(closest)
                    antiAfk()

                    for i, o in ipairs(targets) do
                        if o == closest then table.remove(targets, i) break end
                    end

                    count = 0
                    for _, t in ipairs(backpack:GetChildren()) do if t:IsA("Tool") then count += 1 end end
                end
            end
        end
    end
end)
