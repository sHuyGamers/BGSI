repeat wait() until game:IsLoaded()

local p   = game.Players.LocalPlayer
local c   = p.Character or p.CharacterAdded:Wait()
local bp  = p:WaitForChild("Backpack")
local vu  = game:service("VirtualUser")
local vim = game:service("VirtualInputManager")
local r   = game.ReplicatedStorage
local http= game:service("HttpService")

-- ================== CHECK LEGEND ==================
if getgenv().Config.CheckLegend then
    if not game.Players:FindFirstChild(getgenv().Config.LegendName) then
        print("[CHECKLEGEND] LegendName not found → out server")
        loadstring(game:HttpGet("https://raw.githubusercontent.com/sHuyGamers/BGSI/refs/heads/main/svv"))()
    end
end

-- ================== UTILS ==================
local function has(name,src)
    for _,t in ipairs(src:GetChildren()) do 
        if t:IsA("Tool") and t.Name == name then return t end 
    end 
end

local function equip(n)
    local t=has(n,bp) 
    if t then c.Humanoid:EquipTool(t) return true end 
end

local function needDrop()
    for _,n in ipairs(getgenv().Config.DropList) do 
        local t=has(n,bp)
        if t and t.Parent==bp then return true end 
    end 
    return false
end

local function sendWebhook(lst)
    if not getgenv().Config.SendWebhook or #lst==0 then return end
    local req=(syn and syn.request) or http_request or request
    if not req then return end
    local embeds={}
    for _,b in ipairs(lst) do
        table.insert(embeds,{
            title="🎁 Box Found",
            description=b,
            color=(b:find("Ultra Rare") and 0x800080) or (b:find("Rare") and 0xFFD700) or 0x00FF00,
            footer={text="Finder Bot"},
            url="https://roblox.com/users/"..p.UserId.."/profile"
        })
    end
    req({
        Url=getgenv().Config.WebhookURL,
        Method="POST",
        Headers={["Content-Type"]="application/json"},
        Body=http:JSONEncode({embeds=embeds})
    })
    print("[WEBHOOK] Sent:", table.concat(lst,", "))
end

local function dropBox()
    if not getgenv().Config.AutoDropBox then return end
    
    c.HumanoidRootPart.CFrame = CFrame.new(getgenv().Config.DropPos) 
    task.wait(.2)

    local noclipConn
    noclipConn = game:GetService("RunService").Stepped:Connect(function()
        if c and c:FindFirstChild("Humanoid") then
            c.Humanoid:ChangeState(11) -- Physics state = NoClip
        end
    end)
    print("[NCLP] Noclip Enabled khi drop Box")

    for _,t in ipairs(c:GetChildren())do 
        if t:IsA("Tool") then t.Parent = bp end 
    end

    local lst={}
    for _,n in ipairs(getgenv().Config.DropList) do
        local t=has(n,bp)
        if t then
            table.insert(lst,t.Name) 
            t.Parent=c task.wait(.1)
            vim:SendKeyEvent(true,Enum.KeyCode.Backspace,false,game) task.wait(.05)
            vim:SendKeyEvent(false,Enum.KeyCode.Backspace,false,game) task.wait(.1)
            print("[DROP]",t.Name)
        end
    end

    if #lst>0 then sendWebhook(lst) end
end


-- ================== COMPASS FINDER ==================
local posList={
    Vector3.new(-1317,217,-1299),Vector3.new(-1309,217,-1233),
    Vector3.new(-1281,217,-1179),Vector3.new(-1226,217,-1216),
    Vector3.new(-1220,217,-1273),Vector3.new(-1270,217,-1264),
    Vector3.new(-1214,217,-1332),Vector3.new(-1243,217,-1407)
}

local function teleCompass()
    vim:SendMouseButtonEvent(0,0,0,true,game,0)
    for _,v in ipairs(posList) do
        if needDrop() then 
            vim:SendMouseButtonEvent(0,0,0,false,game,0) 
            dropBox() 
            return 
        end
        if not has("Compass",c) then break end
        c.HumanoidRootPart.CFrame=CFrame.new(v) wait(.1)
    end
    vim:SendMouseButtonEvent(0,0,0,false,game,0)
end

local function runFinder()
    while task.wait(.5) do
        if has("Compass",c) then
            teleCompass()
        elseif has("Compass",bp) then
            equip("Compass")
        else
            wait(2)
        end

        -- Out khi hết Compass + không còn box
        if not has("Compass",bp) and not has("Compass",c) then
            if needDrop() then 
                dropBox()
            else
                print("[FINDER] Hết Compass + Không còn Box → stop loop")
                break
            end
        end
    end
end

-- ================== SAM CLAIM & MAIN ==================
spawn(function()
    local function ready()
        local g=p:FindFirstChild("PlayerGui") 
        local m=g and g:FindFirstChild("Menu")
        local t=m and m.Frame.C.Frame.A.Sam:FindFirstChild("SamTimer")
        return t and t.Text=="Ready!"
    end

    local function claimSam()
        pcall(function() r.Connections.Spawn:FireServer(10) end) wait(.6)
        pcall(function() r.Connections.Claim_Sam:FireServer("Claim10") end)

        wait(6)
        if has("Compass",bp) or has("Compass",c) then
            print("[INFO] Compass vào Backpack (Lần 1) → Finder Start")
            equip("Compass") wait(1)
            runFinder()
        else
            wait(6)
            if has("Compass",bp) or has("Compass",c) then
                print("[INFO] Compass vào Backpack (Lần 2) → Finder Start")
                equip("Compass") wait(1)
                runFinder()
            else
                print("[ERROR] Không thấy Compass sau Claim (Lần 2) → bỏ qua")
            end
        end
    end

    if game.Players:FindFirstChild(getgenv().Config.LegendName) then
        claimSam()
    else
        while wait(5) do
            if ready() then
                print("[TELE] Đang teleport bằng AccessCode...")
                game.RobloxReplicatedStorage.ContactListIrisInviteTeleport:FireServer(
                    game.PlaceId,"",getgenv().Config.AccessCode
                )
                break
            end
        end
    end

    while wait(5) do
        if not has("Compass",bp) and not has("Compass",c) and not needDrop() then
            print("[INFO] Done → Out server")
            loadstring(game:HttpGet("https://raw.githubusercontent.com/sHuyGamers/BGSI/refs/heads/main/svv"))()
            break
        end
    end
end)

-- ================== ANTI AFK ==================
if getgenv().Config.AntiAFK then
    p.Idled:Connect(function()
        vu:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
        wait(1)
        vu:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
    end)
    print("[AUTO] AntiAFK Loaded ✓")
end

-- ================== AUTO REWARD + UPGRADE ==================
spawn(function()
    if not getgenv().Config.AutoReward and not getgenv().Config.AutoUpgrade then return end
    repeat wait() until workspace:FindFirstChild("UserData") and workspace.UserData:FindFirstChild("User_"..p.UserId)
    local store=workspace.UserData["User_"..p.UserId]
    repeat wait() until store:FindFirstChild("FullyLoaded") and store.FullyLoaded.Value
    local Daily=store.Data:WaitForChild("DailyRewardN")
    local Hourly=store.Data:WaitForChild("HourlyRewardN")

    while wait(getgenv().Config.LoopDelay) do
        if getgenv().Config.AutoReward then
            if Daily.Value>0 then store.ClaimRewardDaily:FireServer("RewardMark") end
            if Hourly.Value>0 then store.ClaimRewardHourly:FireServer("RewardMark") end
        end
        if getgenv().Config.AutoUpgrade then r.GlobalReference.SamTokenCapacity:FireServer() end
    end
end)

-- ================== BOOST FPS FULL ==================
if getgenv().Config.BoostFPS then
    for i,v in next, workspace:GetDescendants() do
        pcall(function()
            if v:IsA("BasePart") then v.Material="Plastic" v.Reflectance=0 v.Transparency=1 end
            if v:IsA("Decal") or v:IsA("Texture") then v.Transparency=1 end
            if v:IsA("ParticleEmitter") or v:IsA("Trail") then v.Lifetime=NumberRange.new(0) end
            if v:IsA("Explosion") then v.BlastPressure,v.BlastRadius=1,1 end
            if v:IsA("Fire")or v:IsA("SpotLight")or v:IsA("Smoke")or v:IsA("Sparkles") then v.Enabled=false end
            if v:IsA("MeshPart") then v.Material="Plastic" v.Reflectance=0 v.TextureID=10385902758728957 end
        end)
    end

    workspace.DescendantAdded:Connect(function(v)
        pcall(function()
            if v:IsA("BasePart") then v.Material="Plastic" v.Reflectance=0 v.Transparency=1 end
            if v:IsA("Decal") or v:IsA("Texture") then v.Transparency=1 end
            if v:IsA("ParticleEmitter") or v:IsA("Trail") then v.Lifetime=NumberRange.new(0) end
            if v:IsA("Explosion") then v.BlastPressure,v.BlastRadius=1,1 end
            if v:IsA("Fire")or v:IsA("SpotLight")or v:IsA("Smoke")or v:IsA("Sparkles") then v.Enabled=false end
            if v:IsA("MeshPart") then v.Material="Plastic" v.Reflectance=0 v.TextureID=10385902758728957 end
        end)
    end)

    workspace.ClientAnimatorThrottling = Enum.ClientAnimatorThrottlingMode.Enabled
    workspace.InterpolationThrottling  = Enum.InterpolationThrottlingMode.Enabled
    settings():GetService("RenderSettings").EagerBulkExecution = false
    workspace.LevelOfDetail = Enum.ModelLevelOfDetail.Disabled
    game:GetService("Lighting").GlobalShadows = false
    settings().Rendering.QualityLevel = "Level01"

    local l = game.Lighting
    local t = workspace.Terrain
    t.WaterWaveSize,t.WaterWaveSpeed,t.WaterReflectance,t.WaterTransparency=0,0,0,0
    l.GlobalShadows,l.FogEnd,l.Brightness=false,9e9,0

    for i,e in pairs(l:GetChildren()) do
        if e:IsA("PostEffect") then e.Enabled=false end
    end
    l.ChildAdded:Connect(function(v) if v:IsA("PostEffect") then v.Enabled=false end end)

    print("[AUTO] BoostFPS Loaded ✓ (FULL)")
end

-- ================== BLACK SCREEN ==================
if getgenv().Config.BlackScreen then
    game:GetService("Lighting").ExposureCompensation = -math.huge
    print("[AUTO] BlackScreen Enabled ✓")
end
